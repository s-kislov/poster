<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ПОСТЕР</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
</head>

<body class="container">
<h1 class="mt-4 mb-4">Создание сообщения</h1>

<!-- Уведомления -->
<div id="alert-success" class="alert alert-success d-none" role="alert">
  Пост успешно опубликован!
</div>
<div id="alert-error" class="alert alert-danger d-none" role="alert">
  Возникла ошибка!
</div>

<!-- Поле для выбора канала -->
<div class="mb-3">
  <label for="username" class="form-label">Username канала</label>
  <input type="text" id="username" class="form-control" placeholder="Введите username канала, например @mychannel">
</div>

<!-- Панель инструментов для форматирования текста -->
<div class="btn-toolbar mb-3" role="toolbar">
  <div class="btn-group me-2" role="group">
    <button type="button" class="btn btn-outline-primary" id="bold-btn"><b>B</b></button>
    <button type="button" class="btn btn-outline-primary" id="italic-btn"><i>I</i></button>
    <button type="button" class="btn btn-outline-primary" id="strike-btn"><s>S</s></button>
    <button type="button" class="btn btn-outline-primary" id="monospace-btn"><code>M</code></button>
    <button type="button" class="btn btn-outline-primary" id="spoiler-btn">Спойлер</button>
    <button type="button" class="btn btn-outline-primary" id="code-block-btn">Блок кода</button>
    <button type="button" class="btn btn-outline-primary" id="link-btn">Ссылка</button>
  </div>
</div>

<form id="postForm">
  <div id="editor" class="form-control mb-3" contenteditable="true" style="min-height: 150px;"></div>
  <button type="submit" class="btn btn-primary">Опубликовать сообщение</button>
</form>

<!-- Модальное окно для вставки ссылки -->
<div class="modal fade" id="linkModal" tabindex="-1" aria-labelledby="linkModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="linkModalLabel">Вставить ссылку</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label for="selected-text" class="form-label">Выбранный текст</label>
          <input type="text" id="selected-text" class="form-control" readonly>
        </div>
        <div class="mb-3">
          <label for="link-url" class="form-label">Ссылка</label>
          <input type="text" id="link-url" class="form-control" placeholder="Введите URL">
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отменить</button>
        <button type="button" class="btn btn-primary" id="insert-link-btn">Вставить ссылку</button>
      </div>
    </div>
  </div>
</div>

<script>
  // Показ уведомлений
  function showAlert(type, message) {
    const alertSuccess = document.getElementById('alert-success');
    const alertError = document.getElementById('alert-error');

    if (type === 'success') {
      alertSuccess.classList.remove('d-none');
      alertError.classList.add('d-none');
      alertSuccess.textContent = message;
    } else {
      alertError.classList.remove('d-none');
      alertSuccess.classList.add('d-none');
      alertError.textContent = message;
    }

    // Автоматически скрываем через 3 секунды
    setTimeout(() => {
      alertSuccess.classList.add('d-none');
      alertError.classList.add('d-none');
    }, 3000);
  }

  // WYSIWYG-редактор
  const editor = document.getElementById('editor');
  let selectedRange;  // Для хранения выделенного диапазона текста

  // Очищаем стили текста при вставке
  editor.addEventListener('paste', function(e) {
    e.preventDefault();
    const text = (e.originalEvent || e).clipboardData.getData('text/plain');
    document.execCommand('insertText', false, text);
  });

  // Форматирование текста
  document.getElementById('bold-btn').addEventListener('click', function() {
    document.execCommand('bold');
  });

  document.getElementById('italic-btn').addEventListener('click', function() {
    document.execCommand('italic');
  });

  document.getElementById('strike-btn').addEventListener('click', function() {
    document.execCommand('strikeThrough');
  });

  document.getElementById('monospace-btn').addEventListener('click', function() {
    document.execCommand('insertHTML', false, '<code>' + window.getSelection().toString() + '</code>');
  });

  document.getElementById('spoiler-btn').addEventListener('click', function() {
    document.execCommand('insertHTML', false, '||' + window.getSelection().toString() + '||');
  });

  // Исправленная функция для вставки блока кода
  document.getElementById('code-block-btn').addEventListener('click', function() {
    const selection = window.getSelection();
    const selectedText = selection.toString();
    const preElement = document.createElement('pre');
    const codeElement = document.createElement('code');

    // Добавляем текст в элемент <code>
    codeElement.textContent = selectedText;

    // Вставляем <code> в <pre>
    preElement.appendChild(codeElement);

    // Заменяем выделенный текст на блок кода
    selectedRange = selection.getRangeAt(0);
    selectedRange.deleteContents();  // Удаляем выделенный текст
    selectedRange.insertNode(preElement);  // Вставляем новый элемент <pre><code>
  });

  // Открытие модального окна для вставки ссылки
  document.getElementById('link-btn').addEventListener('click', function() {
    const selection = window.getSelection();
    selectedRange = selection.getRangeAt(0);  // Сохраняем выделение
    const selectedText = selection.toString();
    if (selectedText) {
      document.getElementById('selected-text').value = selectedText;
      const linkModal = new bootstrap.Modal(document.getElementById('linkModal'));
      linkModal.show();
    } else {
      alert('Пожалуйста, выберите текст, чтобы добавить ссылку.');
    }
  });

  // Вставка ссылки из модального окна
  document.getElementById('insert-link-btn').addEventListener('click', function() {
    const url = document.getElementById('link-url').value;
    const selectedText = document.getElementById('selected-text').value;

    if (!url || !selectedText) {
      alert('Пожалуйста, введите корректную ссылку.');
      return;
    }

    const linkNode = document.createElement('a');
    linkNode.href = url;
    linkNode.textContent = selectedText;

    selectedRange.deleteContents();  // Удаляем выделенный текст
    selectedRange.insertNode(linkNode);  // Вставляем ссылку
    const linkModal = bootstrap.Modal.getInstance(document.getElementById('linkModal'));
    linkModal.hide();
  });

  // Отправка поста
  document.getElementById('postForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const content = editor.innerHTML;  // Получаем HTML из редактора
    const username = document.getElementById('username').value;  // Получаем username

    console.log('Content:', content);  // Логируем отправляемое содержимое
    console.log('Username:', username);  // Логируем username

    if (!username) {
      alert('Введите username канала!');
      return;
    }

    fetch('/publish', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ content, username }),
    })
            .then(response => {
              if (!response.ok) {
                throw new Error('Ошибка отправки сообщения');
              }
              return response.json();
            })
            .then(data => {
              showAlert('success', 'Сообщение успешно опубликовано!');
              editor.innerHTML = '';  // Очищаем поле после успешной отправки
            })
            .catch(error => {
              showAlert('error', 'Возникла ошибка: ' + error.message);
            });
  });
</script>

</body>
</html>
